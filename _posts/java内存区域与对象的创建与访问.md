---
layout:     post
title:      java内存区域与对象的创建与访问
subtitle:   java内存区域、对象创建访问
date:       2019-05-09
author:     LHaisong
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - jvm
---
    
## java内存区域

### java虚拟机规范规定java运行时数据区包含以下5个部分：

- 程序计数器：当前线程执行字节码的行号指示器，如果是java代码，则记录的是正在执行的字节码的地址；native方法则为null。
- java虚拟机栈：线程私有区域，生命周期与线程相同；描述的是java方法执行的内存模型，每个方法在执行时会创建一个栈帧，用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每个方法从调用至执行完毕对应着一个栈帧入栈到出栈的过程。
- 堆：堆区是线程共有的区域，在虚拟机启动时创建，用于存放对象的实例；堆区是java垃圾回收的主要区域，从内存回收的角度看，堆区还可以划分为新生代和老年代。虽然线程共享，但是也可以划分许多线程私有的分配缓冲区(TLAB)
- 方法区:与堆区一样为线程共享区域，用于存放已经被虚拟机加载的类信息、常量、静态变量等。
- 本地方法栈：与虚拟机栈内类似，不过本地方法区主要为native方法服务。
- ![](https://res.cloudinary.com/dzdyb9ta5/image/upload/v1567046036/img/29_gdafes.png)

## java对象的创建和访问

- 对象的创建

  1.类加载检查：当遇到一条new指令时，首先要检查这个指令的参数是否在常量池中能定位到该类的符号引用，并检查该类是否已经被加载、解析、初始化过，没有的话则执行类加载过程。

  2.分配内存：分配内存有两种方法：指针碰撞和空闲列表

  - 指针碰撞：假设内存是规整的，空闲区域与已使用的内存用一个指针分隔，分配内存就是将指针往空闲区域移动一段与对象大小相等的距离
  - 空闲列表：虚拟机维护一个列表，记录哪些内存是可用的，分配的时候取出一块足够大的空间分配给对象即可

  > 选择哪种分配方式与java堆是否工整决定的，而java堆是否工整又与采用的垃圾收集器是否有压缩整理有关，因此在使用Serial、ParNew等带有Compact过程的收集器时采用的分配方式为指针碰撞，而类似CMS这种基于标记清除算法的收集器采用的通常是空闲列表分配方式

- 对象的内存布局：对象头、实例数据、填充数据

  对象头包含两部分：

  > 1.对象自身的运行时数据，如哈希码、GC分代年龄、锁状态标志、线程持有锁、偏向线程ID等，这部分也叫Mark Word
  >
  > 2.类型指针：指向对象的元数据，虚拟机通过这个指针确定对象是哪个类的实例

  实例数据部分是对象存储的真正有效信息，也是在程序代码中定义的各种类型的数据

  > 父类继承、子类定义

  填充数据部分不是必然存在的，仅起到占位符的作用

  

- 对象的访问：

  1.句柄访问：在java堆中划出一块内存用作句柄池，栈中reference存放的就是对象的句柄地址，句柄中存放的是对象的实例数据和类型数据的具体地址

  2.直接指针访问：reference中存放的就是对象的地址

