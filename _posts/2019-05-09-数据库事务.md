---
layout:     post
title:      数据库事务
subtitle:   事务、隔离级别、以及每个级别存在的问题
date:       2019-05-09
author:     LHaisong
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - 数据库
---

## 什么是事务？
- 事务是一组SQL语句组成的逻辑处理单元
- 事务的ACID特征：
 1. 原子性：事务是一个原子操作单元，要么全部成功，要么全部失败
 2. 一致性：在事务开始和完成时数据必须保持一致性状态，这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性；事务结束时，所有的内部数据结构（如B树索引或双向链表）也都必须是正确的。
 3. 隔离性：数据库系统提供了一定的隔离机制，保证事务之间的执行是独立的不会相互影响
 4. 持久性：事务一旦提交，则对数据库的修改是永久性的

## 并发事务带来的问题
- 丢失更新：指的是两个或多个事务选择同一行数据更新，由于每个事务都不知道其他事务的存在，所以有的事务所做的修改会被其它事务覆盖掉，这就是丢失更新问题
- 脏读：指一个事务选择一条数据更新，在这个事务提交之前这条数据就处于不一致状态，当其它事务读取改行时，就会读到脏数据
- 不可重复读：一个事务在读取某些数据后的某个时间，再次读取以前读过的数据，却发现其读出的数据已经发生了改变、或某些记录已经被删除了！这种现象就叫做“不可重复读”。
- 幻读：指一个事务按照相同的条件读取以前查询过的数据，但是在这之前一件插入了其它符合条件的数据，这种现象就是幻读

## 事务的隔离级别
- 在并发事务处理带来的问题中，“更新丢失”通常是应该完全避免的。但防止更新丢失，并不能单靠数据库事务控制器来解决，需要应用程序对要更新的数据加必要的锁来解决，因此，防止更新丢失应该是应用的责任。“脏读”、“不可重复读”和“幻读”，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决。
![](https://i.imgur.com/dtjL5Ru.png)

- 数据库实现隔离级别的两种方式
 1. 在访问数据前对其加锁，防止其他事务操作数据
 2. 另一种是不用加任何锁，通过一定机制生成一个数据请求时间点的一致性数据快照（Snapshot)，并用这个快照来提供一定级别（语句级或事务级）的一致性读取。从用户的角度来看，好像是数据库可以提供同一数据的多个版本，因此，这种技术叫做数据多版本并发控制（MultiVersion Concurrency Control，简称MVCC或MCC），也经常称为多版本数据库。
